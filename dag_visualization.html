<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExecutorStep DAG Visualization</title>
    <script type="text/javascript" src="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.js"></script>
    <style type="text/css">
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #2c2c2c; /* Dark grey background */
            color: #f0f0f0; /* Light text color for title etc. */
        }
        #mynetwork {
            width: 100%;
            height: 90vh;
            border: 1px solid #444; /* Darker border for the container */
            background-color: #333333; /* Slightly lighter dark for canvas area if needed, often transparent */
        }
        h2 {
            color: #e0e0e0; /* Light title color */
        }
    </style>
</head>
<body>
    <h2>DAG of <code>tootsie_8b_sensible_starling</code></h2>
    <div id="mynetwork"></div>

    <script type="text/javascript">
        // DOM element to display the network
        var container = document.getElementById('mynetwork');

        // Define nodes (ExecutorSteps)
        var nodes = new vis.DataSet([
            // --- Main Training Lineage ---
            // Phase 1
            { id: 'train_p1_initial', label: 'llama_8b_tootsie_phase1\n(Train P1)', group: 'train', title: 'exp600_tootsie.llama_8b_tootsie_phase1' },
            { id: 'mix_p1_dclm', label: 'dclm_mixture_config_llama3\n(Mixture P1)', group: 'mixture', title: 'exp_dclm_tokenize_dclm.dclm_mixture_config_llama3' },
            
            // Phase 3
            { id: 'train_p3_ema', label: 'llama_8b_tootsie_phase3\n(Train P3)', group: 'train', title: 'exp600_tootsie.llama_8b_tootsie_phase3' },
            { id: 'mix_p3_varied', label: 'phase_3_data_mixture\n(Mixture P3)', group: 'mixture', title: 'exp600_tootsie.phase_3_data_mixture' },
            
            // Adept Phoenix (Checkpoint for Starling)
            { id: 'train_adept_phoenix', label: 'llama_8b_tootsie_adept_phoenix\n(Train AdeptPhoenix)', group: 'train', title: 'exp600_tootsie.llama_8b_tootsie_adept_phoenix' },
            { id: 'mix_adept_phoenix_phase_4', label: 'phase_4_data_mixture\n(Mixture AdeptPhoenix)', group: 'mixture', title: 'exp600_tootsie.phase_4_data_mixture' },

            // Starling Cooldown (Final Target)
            { id: 'train_starling_cooldown', label: 'tootsie_8b_sensible_starling\n(Train Starling)', group: 'train', title: 'exp977_phoenix_cooldown.tootsie_8b_sensible_starling' },
            { id: 'mix_starling_cooldown', label: 'starling_cooldown_mixture\n(Mixture Starling)', group: 'mixture', title: 'exp977_phoenix_cooldown.starling_cooldown_mixture' },

            // --- Component Collections (Data Sources) ---
            // Note: comp_phase_3_tokenized represents dclm_components_llama3, which is the base for several mixtures
            { id: 'comp_phase_3_tokenized', label: 'phase_3_tokenized\n(dclm_components_llama3)', group: 'component_collection', title: 'exp600_tootsie.phase_3_tokenized / exp_dclm_tokenize_dclm.dclm_components_llama3' },
            { id: 'dclm_components_group_node', label: 'DCLM Components Source', group: 'component_collection', hidden: true },
            { id: 'comp_nemotron_cc_steps', label: 'nemotron_cc_steps', group: 'component_collection', title: 'exp600_tootsie.nemotron_cc_steps' },
            { id: 'comp_cooldown_components', label: 'cooldown_components\n(full_mix_components)', group: 'component_collection', title: 'exp934_hq_vs_pt.full_mix_components' },
            { id: 'comp_starling_components', label: 'starling_components', group: 'component_collection', title: 'exp977_phoenix_cooldown.starling_components' },

            // --- phase_3_tokenized dependencies ---
            { id: 'dclm_components_llama3', label: 'dclm_components_llama3', group: 'component_collection', title: 'exp_dclm_tokenize_dclm.dclm_components_llama3' },
            { id: 'tokenize_dclm_baseline', label: 'dclm_baseline\n(Tokenize)', group: 'tokenize', title: 'exp_dclm_tokenize_dclm (dclm_baseline)' },
            { id: 'tokenize_starcoderdata', label: 'starcoderdata\n(Tokenize)', group: 'tokenize', title: 'exp_dclm_tokenize_dclm (starcoderdata)' },
            { id: 'tokenize_proofpile_2', label: 'proofpile_2\n(Tokenize)', group: 'tokenize', title: 'exp_dclm_tokenize_dclm (proofpile_2)' },
            { id: 'download_dclm_baseline', label: 'dclm_baseline\n(Download)', group: 'download', title: 'exp_pretraining_datasets.dclm_baseline' },
            { id: 'download_starcoderdata', label: 'starcoderdata\n(Download)', group: 'download', title: 'exp_pretraining_datasets.starcoderdata' },
            { id: 'download_proofpile_2', label: 'proofpile_2\n(Download)', group: 'download', title: 'exp_pretraining_datasets.proofpile_2' },

            // --- nemotron_cc_steps dependencies ---
            { id: 'tokenize_nemotron_steps_fn', label: 'tokenize_nemotron_steps()', group: 'function_call', title: 'exp_nemotron_cc.tokenize_nemotron.tokenize_nemotron_steps' },
            { id: 'tokenize_nemotron_hq_actual', label: 'nemotron_hq_actual\n(Tokenize)', group: 'tokenize', title: 'exp_nemotron_cc.tokenize_nemotron (hq_actual)' },
            { id: 'tokenize_nemotron_hq_synth', label: 'nemotron_hq_synth\n(Tokenize)', group: 'tokenize', title: 'exp_nemotron_cc.tokenize_nemotron (hq_synth)' },
            { id: 'download_nemotron_cc', label: 'nemotron_cc\n(Download)', group: 'download', title: 'exp_pretraining_datasets.nemotron_cc' },

            // --- cooldown_components (full_mix_components) dependencies ---
            { id: 'tokenize_dolmino_math_llama3', label: 'dolmino_math_tokenized_llama3\n(Tokenize)', group: 'tokenize', title: 'exp_dolmino.tokenize_dolmino.dolmino_math_tokenized_llama3' },
            { id: 'tokenize_dolmino_steps_fn', label: 'tokenize_dolmino_steps()', group: 'function_call', title: 'exp_dolmino.tokenize_dolmino.tokenize_dolmino_steps' },
            { id: 'tokenize_dolmino_flan', label: 'dolmino_flan\n(Tokenize)', group: 'tokenize', title: 'exp_dolmino.tokenize_dolmino (flan)' },
            { id: 'download_dolmino', label: 'dolmino\n(Download)', group: 'download', title: 'exp_pretraining_datasets.dolmino' },
            { id: 'tokenize_md_arxiv', label: 'md_arxiv_tokenized\n(Tokenize - Raw Path)', group: 'tokenize_raw', title: 'exp934_hq_vs_pt.md_arxiv_tokenized' },
            { id: 'tokenize_md_wiki', label: 'md_wiki_tokenized\n(Tokenize - Raw Path)', group: 'tokenize_raw', title: 'exp934_hq_vs_pt.md_wiki_tokenized' },
            { id: 'tokenize_md_stackexchange', label: 'md_stackexchange_tokenized\n(Tokenize - Raw Path)', group: 'tokenize_raw', title: 'exp934_hq_vs_pt.md_stackexchange_tokenized' },
            { id: 'tokenize_medu_mmlu_science_qa', label: 'medu_mmlu_science_qa_tokenized\n(Tokenize - Raw Path)', group: 'tokenize_raw', title: 'exp934_hq_vs_pt.medu_mmlu_science_qa_tokenized' },

            // --- starling_components dependencies ---
            { id: 'tokenize_finemath_3_plus', label: 'finemath_3_plus_tokenized\n(Tokenize)', group: 'tokenize', title: 'exp_midtraining_datasets.finemath_3_plus_tokenized' },
            { id: 'download_finemath', label: 'finemath\n(Download)', group: 'download', title: 'exp_pretraining_datasets.finemath' },
        ]);

        // Define edges (Dependencies) - Corrected: from dependency to dependent
        var edges = new vis.DataSet([
            // Phase 1 Dependencies
            { from: 'mix_p1_dclm', to: 'train_p1_initial' },
            { from: 'comp_phase_3_tokenized', to: 'mix_p1_dclm' }, // dclm_mixture_config_llama3 uses dclm_components_llama3

            // Phase 3 Dependencies
            { from: 'train_p1_initial', to: 'train_p3_ema', label: 'ckpt', dashes: true }, // Checkpoint
            { from: 'mix_p3_varied', to: 'train_p3_ema' },
            { from: 'comp_phase_3_tokenized', to: 'mix_p3_varied' }, // phase_3_data_mixture uses phase_3_tokenized

            // Adept Phoenix Dependencies
            { from: 'train_p3_ema', to: 'train_adept_phoenix', label: 'ckpt', dashes: true }, // Checkpoint
            { from: 'mix_adept_phoenix_phase_4', to: 'train_adept_phoenix' },
            { from: 'comp_phase_3_tokenized', to: 'mix_adept_phoenix_phase_4' },
            { from: 'comp_nemotron_cc_steps', to: 'mix_adept_phoenix_phase_4' },

            // Starling Cooldown Dependencies
            { from: 'train_adept_phoenix', to: 'train_starling_cooldown', label: 'ckpt', dashes: true }, // Checkpoint
            { from: 'mix_starling_cooldown', to: 'train_starling_cooldown' },
            { from: 'comp_phase_3_tokenized', to: 'mix_starling_cooldown' },
            { from: 'comp_nemotron_cc_steps', to: 'mix_starling_cooldown' },
            { from: 'comp_cooldown_components', to: 'mix_starling_cooldown' },
            { from: 'comp_starling_components', to: 'mix_starling_cooldown' },

            // Edges for component_collection: comp_phase_3_tokenized (representing dclm_components_llama3)
            { from: 'dclm_components_group_node', to: 'comp_phase_3_tokenized' },
            { from: 'tokenize_dclm_baseline', to: 'dclm_components_group_node' }, 
            { from: 'tokenize_starcoderdata', to: 'dclm_components_group_node' },   
            { from: 'tokenize_proofpile_2', to: 'dclm_components_group_node' },     
            { from: 'download_dclm_baseline', to: 'tokenize_dclm_baseline' },
            { from: 'download_starcoderdata', to: 'tokenize_starcoderdata' },
            { from: 'download_proofpile_2', to: 'tokenize_proofpile_2' },

            // Edges for nemotron_cc_steps
            { from: 'tokenize_nemotron_steps_fn', to: 'comp_nemotron_cc_steps' },
            { from: 'tokenize_nemotron_hq_actual', to: 'tokenize_nemotron_steps_fn' }, 
            { from: 'tokenize_nemotron_hq_synth', to: 'tokenize_nemotron_steps_fn' }, 
            { from: 'download_nemotron_cc', to: 'tokenize_nemotron_hq_actual' },
            { from: 'download_nemotron_cc', to: 'tokenize_nemotron_hq_synth' },

            // Edges for cooldown_components
            { from: 'tokenize_dolmino_math_llama3', to: 'comp_cooldown_components' },
            { from: 'download_dolmino', to: 'tokenize_dolmino_math_llama3' },
            { from: 'tokenize_dolmino_steps_fn', to: 'comp_cooldown_components' },
            { from: 'tokenize_dolmino_flan', to: 'tokenize_dolmino_steps_fn' }, 
            { from: 'download_dolmino', to: 'tokenize_dolmino_flan' },
            { from: 'tokenize_md_arxiv', to: 'comp_cooldown_components' },
            { from: 'tokenize_md_wiki', to: 'comp_cooldown_components' },
            { from: 'tokenize_md_stackexchange', to: 'comp_cooldown_components' },
            { from: 'tokenize_medu_mmlu_science_qa', to: 'comp_cooldown_components' },

            // Edges for starling_components
            { from: 'tokenize_finemath_3_plus', to: 'comp_starling_components' },
            { from: 'download_finemath', to: 'tokenize_finemath_3_plus' },
        ]);

        // Provide the data in the vis format
        var data = {
            nodes: nodes,
            edges: edges
        };

        // Options for the network visualization
        var options = {
            layout: {
                hierarchical: {
                    direction: "LR", // Direction: Left-Right
                    sortMethod: "directed", // Sort by the direction of the edges
                    shakeTowards: "roots",
                    levelSeparation: 300, // Increased separation for LR layout
                    nodeSpacing: 120,
                }
            },
            interaction: { 
                dragNodes: true,
                zoomView: true,
                dragView: true 
            },
            physics: {
                enabled: true, // Enable physics for a more organic layout initially
                hierarchicalRepulsion: {
                    nodeDistance: 150
                },
                solver: 'hierarchicalRepulsion' // More suited for hierarchical layouts
            },
            nodes: {
                shape: 'box',
                margin: 10,
                widthConstraint: { maximum: 200 },
                font: { size: 12 }
            },
            edges: {
                arrows: 'to',
                smooth: {
                    enabled: true,
                    type: "cubicBezier",
                    forceDirection: 'horizontal', // Changed for LR layout
                    roundness: 0.4
                },
                font: { align: 'middle', size: 10, color: '#cccccc' } // Light grey for edge labels
            },
            groups: {
                train: { color: { background: '#E57373', border: '#D32F2F' }, font: { color: '#FFFFFF' } }, // Muted Red
                mixture: { color: { background: '#64B5F6', border: '#1976D2' }, font: { color: '#FFFFFF' } }, // Muted Blue
                component_collection: { color: { background: '#FFF176', border: '#FBC02D' }, font: { color: '#212121' }, shape: 'box' }, // Muted Yellow (dark text for contrast)
                tokenize: { color: { background: '#81C784', border: '#388E3C' }, font: { color: '#FFFFFF' } }, // Muted Green
                tokenize_raw: { color: { background: '#9575CD', border: '#512DA8' }, font: { color: '#FFFFFF' } }, // Muted Purple
                download: { color: { background: '#B0BEC5', border: '#607D8B' }, font: { color: '#212121' } }, // Muted Grey (dark text for contrast)
                function_call: { color: { background: '#FFB74D', border: '#F57C00' }, shape: 'ellipse', font: { color: '#FFFFFF' } } // Muted Orange
            }
        };

        // Initialize the network!
        var network = new vis.Network(container, data, options);

        // For a better initial layout with hierarchical, disable physics after stabilization
        network.on("stabilizationIterationsDone", function () {
            network.setOptions( { physics: false } );
        });

    </script>

</body>
</html>
